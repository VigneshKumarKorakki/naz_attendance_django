<section class="block">
  <p class="section-title" data-i18n="dash.select_attendance">Select Attendance</p>
  <div class="date-card">
    <button class="nav-btn" id="prev-day" type="button" aria-label="Previous day">&lt;</button>
    <div class="date-info">
      <div class="day" id="display-day-name"></div>
      <div class="date" id="display-date-text"></div>
    </div>
    <button class="nav-btn" id="next-day" type="button" aria-label="Next day">&gt;</button>
  </div>
</section>

<script>
  (function() {
    let currentDate = new Date();
    currentDate.setHours(0, 0, 0, 0);
    const today = new Date(currentDate);
    
    const dayEl = document.getElementById("display-day-name");
    const dateEl = document.getElementById("display-date-text");
    const prevBtn = document.getElementById("prev-day");
    const nextBtn = document.getElementById("next-day");
    const localeMap = {
      en: "en-US",
      ur: "ur-PK",
      rn: "rn-BI",
    };

    function getLocale() {
      const lang = localStorage.getItem("workerLang") || "en";
      return localeMap[lang] || lang;
    }

    function formatDate(date) {
      const locale = getLocale();
      const dayName = new Intl.DateTimeFormat(locale, {
        weekday: "long",
      }).format(date);
      const dateStr = new Intl.DateTimeFormat(locale, {
        day: "2-digit",
        month: "short",
        year: "numeric",
      }).format(date);
      return {
        dayName: dayName,
        dateStr: dateStr
      };
    }

    function updateDisplay(emitEvent = true) {
      const fmt = formatDate(currentDate);
      dayEl.textContent = fmt.dayName;
      dateEl.textContent = fmt.dateStr;
      
      const monthIndex = String(currentDate.getMonth() + 1).padStart(2, "0");
      const dayIndex = String(currentDate.getDate()).padStart(2, "0");
      const payloadDate = `${currentDate.getFullYear()}-${monthIndex}-${dayIndex}`;
      dateEl.dataset.isoDate = payloadDate;
      if (emitEvent) {
        window.dispatchEvent(
          new CustomEvent("attendance:date-changed", {
            detail: {
              displayDate: fmt.dateStr,
              formattedDate: payloadDate,
              date: new Date(currentDate),
            },
          })
        );
      }
      nextBtn.disabled = currentDate >= today;
    }

    // Initialize
    updateDisplay();

    prevBtn.addEventListener("click", () => {
      currentDate.setDate(currentDate.getDate() - 1);
      updateDisplay();
    });

    nextBtn.addEventListener("click", () => {
      if (currentDate >= today) return;
      currentDate.setDate(currentDate.getDate() + 1);
      updateDisplay();
    });

    window.addEventListener("worker:language-changed", () => {
      updateDisplay(false);
    });

  })();
</script>
